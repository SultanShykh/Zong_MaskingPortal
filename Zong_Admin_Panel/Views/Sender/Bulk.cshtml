@{
    ViewBag.Title = "Index";
}
<style>
    /*button#upload {
        font-size: .875rem;
        position: relative;
        transition: all .15s ease;
        letter-spacing: .025em;
        text-transform: none;
        will-change: transform;
        float: right;
        margin-left: 72%;
    }*/

    div#DataTables_Table_0_filter {
        margin-left: auto;
    }

    #hhs {
        width: 153%;
    }

    div#detail {
        width: 60%;
        margin-left: 24%;
    }

    label#attached {
        cursor: pointer;
    }

    .container-fluid.d-flex.align-items-center .btn {
        width: -8%;
        margin-left: -27%;
        width: 13%;
    }
    img#imggif {
        width: 269px;
        margin-top: -32px;
        margin-left: -19px;
    }
</style>

@*

    <div class="container-fluid mt--6">
        @*<div class="row">
            <div class="col">*@
<div class="card">
    <div class="card-header card-header-primary d-flex align-items-center">
        <h3 class="card-title mr-auto text-white mb-0 ">BULK</h3>
        <button id='upload' type='button' class='btn btn-accent-color btn-md create'> <i class='fas fa-plus'></i> BULk Upload </button>
    </div>
    <div class="card-body px-0">
        <!-- Light table -->
        <div class="table-responsive">
            <table class="table tblmanage display " style="width:100%">
                <thead class="thead-light">
                    <tr>
                        <th scope="col" hidden>#</th>
                        <th scope="col">ACCOUNT NUMBER</th>
                        @*<th scope="col">USER NAME</th>*@
                        <th scope="col">Masking ID</th>
                        <th scope="col">NTN/FTN</th>
                        <th scope="col">OPERATOR</th>
                        <th scope="col">NTN/FTN STATUS</th>

                        @*<th scope="col">Request</th>
                            <th scope="col">Zong</th>
                            <th scope="col">Jazz</th>
                            <th scope="col">Telenor</th>
                            <th scope="col">Ufone</th>*@
                          @*<th scope="col">STATUS</th>
                            <th scope="col">Requested To</th>
                            <th scope="col">Requested BY</th>
                            <th scope="col">Reverted By</th>
                            <th scope="col">Approved By</th>
                            <th scope="col">Reverted Reason</th>*@
                        <th scope="col">Comments</th>
                        <th scope="col" id="button">Attachments</th>
                    </tr>
                    @*<tr>
                            <th scope="col"></th>

                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col">Request</th>
                            <th scope="col">Zong</th>
                            <th scope="col">Jazz</th>
                            <th scope="col">Telenor</th>
                            <th scope="col">Ufone</th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                        </tr>*@
                </thead>
                <tbody class="list">
                </tbody>
            </table>
        </div>
    </div>
    <!-- Card footer -->
    @*<div class="card-footer py-4">
            <nav aria-label="...">
                <ul class="pagination justify-content-end mb-0">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">
                            <i class="fas fa-angle-left"></i>
                            <span class="sr-only">Previous</span>
                        </a>
                    </li>
                    <li class="page-item active">
                        <a class="page-link" href="#">1</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="#">2 <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">
                            <i class="fas fa-angle-right"></i>
                            <span class="sr-only">Next</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>*@
    @*</div>
        </div>*@
    <div class="card-footer">
        <button type="button" id="btnSave" value="Save" class="btn btn-primary float-right">Save</button>
        <button type="button" class="btn btn-danger float-right" id="btnclear" style="display:none;" >Clear</button>
   
          <div id="loader" style="width:20px; display:none;">
              <img src="~/Content/default_theme/assets/img/ZongLoader.gif" id="imggif" />
        </div> 
    
    </div>

</div>

<!-- Footer -->
<footer class="footer pt-0">
    <div class="row align-items-center justify-content-lg-between">
        <div class="col-lg-6">
            <div class="copyright text-center  text-lg-left  text-muted">
                &copy;
                <script type="text/javascript">
                    document.write(new Date().getFullYear());
                </script> <a href="https://https://www.zong.com.pk/" class="font-weight-bold ml-1" target="_blank">CMPAK</a>
            </div>
        </div>
        <div class="col-lg-6">
        </div>
    </div>
</footer>
</div>
<!-- ADD MODAL -->
<div class="modal fadeIn" id="addRowModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="mtitle">
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="form">
                    <div class="row">
                        @Html.Hidden("Id")
                        @Html.Hidden("RevertedByyy")
                        @Html.Hidden("CreatorType")


                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label " for="input-username">Account Number</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <input type="text" id="input-account" name="AccountNumber" class="form-control" placeholder="Type:">
                                <label class="form-control-label " id="accounts" style="display:none;color:red;">Please Enter a Field</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">Masking ID</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <input type="text" id="input-sender" name="Masking" class="form-control" placeholder="Type:">
                                <label class="form-control-label " id="senders" style="display:none;color:red;">Please Enter a Field</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">NTN/FTN</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <input type="text" id="input-ntn-ftn" name="NTN_FTN" class="form-control" placeholder="Type:">
                                <label class="form-control-label " id="ntnftn" style="display:none;color:red;">Please Enter a Field</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">Operator</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="operator" name="Operator" value="2" class="custom-control-input" checked="checked">
                                    <label class="custom-control-label" for="customRadioInline1">OFF NET</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">NTN/FTN Status</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="customRadioInline1" name="NTN_FTN_Status" value="true" class="custom-control-input">
                                    <label class="custom-control-label" for="customRadioInline1">Verified</label>
                                </div>
                                <span> | &nbsp;</span>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="customRadioInline2" name="NTN_FTN_Status" value="false" class="custom-control-input">
                                    <label class="custom-control-label" for="customRadioInline2">Non Verified</label>
                                </div>
                                <label class="form-control-label " id="ntnstatus" style="display:none;color:red;"></label>
                            </div>
                        </div>
                    </div>
                    @*<div class="row">
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label class="form-control-label" for="input-username">Operators</label>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <div class="custom-control custom-radio custom-control-inline">
                                        <input type="radio" id="customRadioInline3" name="Operators" value="1" class="custom-control-input">
                                        <label class="custom-control-label" for="customRadioInline3">On Net</label>
                                    </div>
                                    <span> | &nbsp;</span>
                                    <div class="custom-control custom-radio custom-control-inline">
                                        <input type="radio" id="customRadioInline4" name="Operators" value="2" class="custom-control-input">
                                        <label class="custom-control-label" for="customRadioInline4">All Net</label>
                                    </div>
                                </div>
                            </div>
                        </div>*@
                    <div class="row" hidden>
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">Priority</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="customRadioInline5" name="Priority" value="0" class="custom-control-input">
                                    <label class="custom-control-label" for="customRadioInline5">Normal</label>
                                </div>
                                <span> | &nbsp;</span>
                                <div class="custom-control custom-radio custom-control-inline">
                                    <input type="radio" id="customRadioInline6" name="Priority" value="1" class="custom-control-input">
                                    <label class="custom-control-label" for="customRadioInline6">Urgent</label>
                                </div>
                                <label class="form-control-label " id="priorities" style="display:none;color:red;"></label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">Attahment(s)</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <div class="custom-file" id="textboxDiv">
                                    <input type="file" class="custom-file-input" name="Attachments" id="customFileLang" lang="en" multiple="multiple">
                                    <label class="custom-file-label" for="customFileLang">Select file</label>
                                </div>
                                <label class="form-control-label " id="filesss" style="display:none;color:red;">Please Select a File</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-3">
                            <div class="form-group">
                                <label class="form-control-label" for="input-username">Comments</label>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group">
                                <textarea rows="4" class="form-control" id="Comment" name="Comments" placeholder=""></textarea>
                                <label class="form-control-label " id="comments" style="display:none;color:red;">Please Enter a Field</label>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                        </div>
                        <div class="col-lg-6">
                            <div class="form-group" style="text-align: center;">
                                <button type="submit" class="btn btn-secondary btn-lg sender-button" id="btnSubmit">Save</button>
                                
                            </div>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
<!-- END ADD MODAL -->
@*- Bulk Upload Modal*@
<div class="modal fade" id="UploadModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">

                <h4 id="ModalTitle">Upload Bulk File</h4>
                <a href="#" onclick="cancel()" class="close" data-dismiss="modal">&times;</a>
            </div>
            <div class="modal-body">
                <form id="bulkform" class="form">
                    <fieldset id="Submitform">


                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group  ">
                                    <label>Upload File</label>

                                    <input type="file" id="file" class="form-control" name="file" required />
                                    <label id="Filediv" style="display:none; color: red">File Is Missing </label>


                                </div>

                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <a class="btn btn-outline" href="@Url.Action("Sample", "Sender")" style="margin-top: 35px; background-color:deepskyblue; color:white;">Sample</a>
                                </div>
                            </div>


                        </div>
                    </fieldset>


                </form>

                <div class="form-group">
                    <input class="btn btn-block btn-info" type="submit" id="Upload" />
                </div>
            </div>
        </div>
    </div>

</div>

<!-- End Bulk Upload Modal-->

@section scripts
{
    <script src="~/Scripts/ProjectScript/InProcessScript.js"></script>
    <script src="~/Scripts/ProjectScript/InProcessScript.js"></script>
    <script src="~/Scripts/jszip.min.js"></script>
    <script src="~/Scripts/jszip-utils.min.js"></script>
    <script src="~/Scripts/FileSaver.min.js"></script>
    <script src="~/Scripts/ProjectScript/SenderScript.js"></script>
    <script src="~/Scripts/ProjectScript/CrudScript.js"></script>


    <script>
        var initiator = '';
        var links = [];
        var dt = "";
        var ss = "";
        var isValid = true;

        $("form#form").submit(function (e) {
            debugger
            var formData = new FormData(this);
            e.preventDefault();
            if (SenderScript.Validate()) {
                var ss = $('#customFileLang').val();
                if ($('#Id').val() > 0) {

                    SenderScript.UpdateUser(formData);
                    links = [];
                }
                else {

                    SenderScript.SaveUser(formData);


                }

                $('#addRowModal').modal('hide');
            }
        });

        $(document).ready(function () {
            
            debugger
            var datalist = localStorage.getItem("BulkList");

            if (datalist != null) {

                CrudScript.JqueryPFDataTable('.tblmanage', JSON.parse(datalist), SenderScript.BulkColumns);
            }
                //var data = '/Sender/Bulk';
           
        });

        $(document).on('click', '.edit', function () {

            var data = $('.tblmanage').DataTable().row($(this).closest('tr')).data();

            $('.modal-title').text("Update Masking");
            cancel();
            SenderScript.FillModal(data);

        });
        $(document).on('click', '.history', function () {
            debugger
            var data = $('.tblmanage').DataTable().row($(this).closest('tr')).data();

            SenderScript.LoadHistory(data.Id);

        });



        $('#btnSave').click(function () {

            SenderScript.ValidateTable();

        });


        $('#btnclear').click(function ()
        {
            debugger
            localStorage.removeItem("BulkList");
            var mainTable = $('.tblmanage').DataTable();
            mainTable.destroy();
            window.location.reload();
            
        });

        $('#upload').click(function () {
            $("#form").trigger('reset');
            $('#Filediv').css('display', 'none');
            $('#UploadModal').modal("show");
            $("#file").val(null);

        })
        $('#Upload').click(function () {
            //var formData = new FormData(this);
            $("#btnSave").show();
            $("#btnclear").hide();
            SenderScript.UploadBulk();


        })






        /////Selected Row/////////
        $('.tblmanage').on('click', 'tr', function () {


            var ss = $(".tblmanage tr").hasClass('selected');
            if (ss == false) {
                $(this).removeClass('selected');
            }

            if (ss) {

                var domain = window.location.origin;
                var $row = $(this).closest("tr");

                dt = $('.tblmanage').DataTable().row($(this).closest('tr')).data();

                if (!links.includes(dt.Attachment)) {
                    if (dt.Attachment != " -- ") {
                        var filelocation = dt.Attachment;
                        filelocation = filelocation.split(',');
                        filelocation.forEach(function (f, i) {
                            filelocation = f.split('Zong_Admin_Panel\\').pop();
                            links.push(filelocation);
                        });
                    }

                }
                else {
                    links.splice($.inArray(filelocation, links), 1);
                }
                console.log(links);
            }
        });




        $(document).on('click', '.buttons-excel', function (data) {

            debugger
            if (links.length > 0) {

                generateZIP();
            }

            else {
                links = [];
                MSM();
                generateZIP();

            }

        });



        function MSM() {
            debugger
            var domain = window.location.origin;
            var data = $('.tblmanage').DataTable().data();
            $.each(data, function (url, i) {
                debugger
                if (!links.includes(i.Attachment)) {
                    if (i.Attachment != " -- ") {


                        var filelocation = i.Attachment.split(',');
                        filelocation.forEach(function (f, i) {
                            filelocation = f.split('Zong_Admin_Panel\\').pop();
                            links.push(filelocation);
                            filelocation = filelocation.split(',');

                        });
                    }
                }
                else {
                    links.splice($.inArray(filelocation, links), 1);
                }
            });

        }




        function generateZIP() {
            debugger
            console.log('TEST');
            var zip = new JSZip();
            var count = 0;
            var zipFilename = "Attachments.zip";
            var domain = window.location.origin;
            var ss = "";

            links.forEach(function (url, i) {
                debugger
                JSZipUtils.getBinaryContent(url, function (err, data) {
                    debugger
                    if (data != null) {
                        zip.file(url, data, { binary: true });
                        count++;
                        if (count == links.length) {
                            zip.generateAsync({ type: 'blob' }).then(function (content) {
                                debugger
                                saveAs(content, zipFilename);
                                links = [];
                                ShowDivSuccess("Download Successfully!!!");
                                var ss = "/Sender/GetAll";
                                SenderScript.RenderDataTable(ss);

                            });
                        }
                    }
                });
            });
        }



    </script>
}